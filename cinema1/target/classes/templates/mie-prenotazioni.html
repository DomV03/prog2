<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <meta charset="UTF-8" />
    <title>Le mie prenotazioni</title>
    <link rel="stylesheet" href="/css/stile.css" />
</head>
<body class="h-100 d-flex flex-column">

    <header class="d-flex justify-content-between align-items-center py-3">
        <div style="flex-grow: 1;"></div>

        <div style="flex-grow: 1; text-align: center;">
            <a href="/">
                <img class="logo img-fluid" src="/images/logoC.png" alt="Logo Cinema" style="max-height: 100px;">
            </a>
        </div>

        <div style="flex-grow: 1; text-align: end;">
            <div th:if="${userDetails}">
				<a href="/mie-prenotazioni">
                <span th:text="${userDetails.username}"></span>
				</a>
                <a href="/logout" class="btn btn-outline-danger ms-2">Logout</a>
            </div>
            <div th:unless="${userDetails}">
                <a href="/login" class="btn btn-outline-primary">Login</a>
            </div>
        </div>
    </header>

    <div class="container my-5 flex-grow-1">
        <h1 class="text-center">Le mie prenotazioni</h1>
        <div class="table-responsive">
            <table class="table table-striped table-hover mt-4">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Film</th>
                        <th scope="col">Data e Orario</th>
                        <th scope="col">Sala</th>
                        <th scope="col">Posto</th>
                    </tr>
                </thead>
                <tbody id="prenotazioni-table-body">
                    </tbody>
            </table>
        </div>
        <p id="no-prenotazioni-msg" class="text-center text-muted mt-5 d-none">Non hai ancora effettuato nessuna prenotazione.</p>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            fetch('/api/prenotazioni/mie-prenotazioni')
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.getElementById('prenotazioni-table-body');
                    if (data && data.length > 0) {
                        data.forEach(prenotazione => {
                            const row = document.createElement('tr');
                            const orario = new Date(prenotazione.spettacolo.orario).toLocaleString('it-IT', {
                                dateStyle: 'long',
                                timeStyle: 'short'
                            });
                            row.innerHTML = `
                                <td>${prenotazione.spettacolo.film.titolo}</td>
                                <td>${orario}</td>
                                <td>${prenotazione.spettacolo.sala.codice}</td>
                                <td>${prenotazione.posto.codice}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {

                        document.getElementById('no-prenotazioni-msg').classList.remove('d-none');
                    }
                })
                .catch(error => console.error('Errore nel caricamento delle prenotazioni:', error));
        });
    </script>
</body>
</html>