<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <meta charset="UTF-8" />
    <title th:text="${film.titolo}"></title>
    <link rel="stylesheet" href="/css/stile.css" />
    <style>
        .posto.libero {
            background-color: #28a745; /* verde */
            color: white;
            cursor: pointer;
        }

        .posto.occupato {
            background-color: #dc3545; /* rosso */
            color: white;
            cursor: not-allowed;
        }
        
        .posto.selezionato {
            background-color: #ffc107; /* giallo */
        }
        
        .posto {
            width: 40px;
            height: 40px;
            margin: 5px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Stile per il bottone selezionato */
        .btn-primary.selected {
            background-color: #28a745; /* Verde */
            border-color: #28a745;
            color: white;
        }
    </style>
</head>
<body class="h-100" th:attr="data-spettacolo-id=${spettacoloId}">
	
    <header class="d-flex justify-content-between align-items-center py-3">
        <div style="flex-grow: 1;"></div>
        <div style="flex-grow: 1; text-align: center;">
            <a href="/">
                <img class="logo img-fluid" src="/images/logoC.png" alt="Logo Cinema" style="max-height: 100px;">
            </a>
        </div>
        <div style="flex-grow: 1; text-align: end;">
            <div th:if="${userDetails}">
				<a href="/mie-prenotazioni">
					            <span th:text="${userDetails.username}"></span>
								</a>
                <a href="/logout" class="btn btn-outline-danger ms-2">Logout</a>
            </div>
            <div th:unless="${userDetails}">
                <a href="/login" class="btn btn-outline-primary">Login</a>
            </div>
        </div>
    </header>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <h1 class="text-center" th:text="${film.titolo}"></h1>
            
            <div class="card mb-3 col-10">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img th:src="${film.immagineCopertinaUrl}" class="img-fluid rounded-start" alt="Copertina film" style="height: 100%; object-fit: cover;">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${film.titolo}"></h5>
                            <p class="card-text">
                                <strong>Regista:</strong> <span th:text="${film.regista}"></span><br>
                                <strong>Attori:</strong> <span th:text="${film.attori}"></span><br>
                                <strong>Durata:</strong> <span th:text="${film.durataMinuti} + ' min'"></span><br>
                                <strong>Età Minima:</strong> <span th:text="${film.etaMinima}"></span>
                            </p>
                            <hr>
                            <p><strong>Trama:</strong></p>
                            <p th:text="${film.trama}"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="spettacoli-list col-10">
                <h3 class="text-center">Spettacoli Disponibili:</h3>
                <ul class="list-group list-group-horizontal-md justify-content-center flex-wrap">
                    <li class="list-group-item m-2" th:each="spettacolo : ${spettacoli}">
                        <a href="#" class="btn-spettacolo" th:data-spettacolo-id="${spettacolo.id}">
                            <button class="btn btn-primary" th:text="${#temporals.format(spettacolo.orario, 'dd-MM-yyyy HH:mm')}"></button>
                        </a>
                    </li>
                </ul>
                <div th:if="${#lists.isEmpty(spettacoli)}" class="alert alert-info mt-3 text-center">
                    Nessuno spettacolo disponibile per questo film al momento.
                </div>
            </div>
            
            <div id="selezionePosti" style="display: none;">
                <h3 class="text-center mt-5">Seleziona il tuo posto:</h3>
                <div class="row justify-content-center">
                    <div class="col-8 text-center">
                        <div id="mappaPosti" class="mt-4">
                            </div>
                        <button id="bottonePrenota" class="btn btn-success mt-4">Prenota</button>
                        <div id="messaggioPrenotazione" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<script th:inline="javascript">
	    const spettacoliList = document.querySelector('.spettacoli-list');
	    const selezionePostiDiv = document.getElementById('selezionePosti');
	    const mappaPostiDiv = document.getElementById('mappaPosti');
	    const bottonePrenota = document.getElementById('bottonePrenota');
	    const messaggioPrenotazione = document.getElementById('messaggioPrenotazione');
	    let spettacoloCorrenteId = null;

	    function selezionaBottoneOrario(id) {
	        document.querySelectorAll('.btn-primary').forEach(btn => {
	            btn.classList.remove('selected');
	        });
	        const linkDaSelezionare = document.querySelector(`.btn-spettacolo[data-spettacolo-id="${id}"]`);
	        if (linkDaSelezionare) {
	            const bottone = linkDaSelezionare.querySelector('.btn-primary');
	            if(bottone) {
	                bottone.classList.add('selected');
	            }
	        }
	    }

	    function caricaPosti(spettacoloId) {
	        spettacoloCorrenteId = spettacoloId;
	        mappaPostiDiv.innerHTML = 'Caricamento posti...';
	        selezionePostiDiv.style.display = 'block';

			fetch(`/api/spettacoli/${spettacoloId}/posti`)
			       .then(response => response.json())
			       .then(posti => {
			           mappaPostiDiv.innerHTML = '';
			           posti.forEach(posto => {
			               const postoElement = document.createElement('div');
			               // Usa i campi del DTO
			               postoElement.setAttribute('data-posto-id', posto.postoId); 
			               postoElement.setAttribute('data-posto-occupato', posto.occupato);
			               postoElement.className = `posto ${posto.occupato ? 'occupato' : 'libero'}`;
			               postoElement.textContent = posto.codicePosto;
			               mappaPostiDiv.appendChild(postoElement);
			           });
	            });
	    }

		function pulisciSelezionePosti() {
		    document.querySelectorAll('.posto.selezionato').forEach(posto => {
		        posto.classList.remove('selezionato');
		    });
		    messaggioPrenotazione.textContent = '';
		}
		
	    const idSelezionato = document.body.dataset.spettacoloId;
	    if (idSelezionato) {
	        selezionaBottoneOrario(idSelezionato);
	        caricaPosti(idSelezionato);
	    }

	    spettacoliList.addEventListener('click', (event) => {
	        const target = event.target;
	        const link = target.closest('.btn-spettacolo');
	        if (link) {
	            event.preventDefault();
	            selezionaBottoneOrario(link.dataset.spettacoloId);
	            caricaPosti(link.dataset.spettacoloId);
	        }
	    });

	    mappaPostiDiv.addEventListener('click', (event) => {
	        const posto = event.target;
	        if (posto.classList.contains('posto') && posto.dataset.postoOccupato === 'false') {
	            posto.classList.toggle('selezionato');
	        }
	    });

	    bottonePrenota.addEventListener('click', () => {
	        const postiSelezionati = document.querySelectorAll('.posto.selezionato');
	        if (postiSelezionati.length === 0) {
	            alert('Seleziona almeno un posto.');
	            return;
	        }

	        const spettacoloIdNumero = Number(spettacoloCorrenteId);
	        const postoIdsNumeri = Array.from(postiSelezionati).map(p => parseInt(p.dataset.postoId));

	        if (!spettacoloCorrenteId) {
	            alert('Seleziona prima un orario dello spettacolo.');
	            return;
	        }

	        fetch('http://localhost:8081/api/prenotazioni/nuova', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	            },
	            body: JSON.stringify({
	                spettacoloId: spettacoloIdNumero,
	                postoIds: postoIdsNumeri
	            })
	        })
	        .then(response => {
	            // Se la risposta è 401 (Unauthorized), reindirizza al login.
	            if (response.status === 401) {
	                window.location.href = '/login';
	                return null; // Ferma il resto della catena .then
	            }
	            // Altrimenti, continua a processare la risposta JSON.
	            return response.json();
	        })
			.then(data => {
			    if (data && data.message) {
			        if (data.message === 'Prenotazione effettuata con successo!') {
			            messaggioPrenotazione.textContent = data.message;
			            messaggioPrenotazione.style.color = 'green';
			            caricaPosti(spettacoloCorrenteId); // Ricarica la mappa dei posti
			            pulisciSelezionePosti(); // Pulisci la selezione dei posti dopo una prenotazione
			        } else {
			            messaggioPrenotazione.textContent = 'Errore: ' + data.message;
			            messaggioPrenotazione.style.color = 'red';
			        }
			    }
			})
			.catch(error => {
			    console.error('Errore:', error);
			    messaggioPrenotazione.textContent = 'Si è verificato un errore inaspettato.';
			    messaggioPrenotazione.style.color = 'red';
			});
	    });
	</script>
</body>
</html>